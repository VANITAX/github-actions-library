#!/bin/bash

hosts_file="$GITHUB_WORKSPACE/.github/hosts.yml"

if [ "$GITHUB_REF" = "" ]; then
    echo "\$GITHUB_REF is not set"
    exit 1
fi

cat "$hosts_file" | shyaml keys-0 | \
while read -r -d $'\0' branch; do
    gh_ref="refs/heads/$branch"
    if [ "$GITHUB_REF" = "$gh_ref" ]; then
        echo "$GITHUB_REF matches $gh_ref"
        exit 0
    fi
done

# If it reaches here then there have been no matches
echo "$GITHUB_REF does not match with any given branch in 'hosts.yml'"
exit 78
